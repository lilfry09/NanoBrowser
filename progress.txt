# 项目进度记录 (Progress Log)

这里记录着 AI 自动开发系统每一次完成的工作内容。
人类开发者和未来的 AI Agent 都可以通过阅读此文件了解项目的变更历史。

---

## 系统初始化
- 自动开发守护进程 (Infinite Daemon) 已就绪。
- Git 仓库已初始化。
- `CLAUDE.md`, `task.json`, `run-infinite.sh` 配置文件已生成。

## [2026-02-21 21:55:00] - 完成任务: 项目初始化与基础环境配置
- 创建了 requirements.txt 包含 PyQt6 和 PyQt6-WebEngine。
- 成功安装了相关的 Python 依赖库。
- 创建了 src 目录并编写了 main.py 输出 Hello Browser。
- 测试方法与结果：执行 `python src/main.py` 成功输出内容。
- 注意事项：后续任务将基于 PyQt6-WebEngine 构建浏览器的主窗口，依赖环境现已完全就绪。

## [2026-02-21 22:00:00] - 完成任务: 基础浏览器窗口实现 & 顶部导航栏与地址栏
- 在 `src/main.py` 引入了 `PyQt6` 相关的 `QMainWindow`, `QToolBar`, `QLineEdit`, `QWebEngineView`。
- 创建了 `MainWindow` 主窗口，并实例化了 `QWebEngineView` 作为 CentralWidget。
- WebView 默认加载 'https://www.bing.com'，实现了一个真正的极简窗口浏览器。
- 添加了基础工具栏 `QToolBar`，并实装了后退、前进、刷新、主页四个操作按钮。
- 地址栏实现了绑定事件：输入网址回车跳转，以及页面跳转后自动更新地址栏文本。
- 增加了智能前缀判断：若用户输入 URL 缺少协议头，会自动补全 `https://`。

## [2026-02-21 22:05:00] - 完成任务: 多标签页 (Tab) 支持
- 使用 `QTabWidget` 替换了原有的单一 `QWebEngineView`。
- 实现 `add_new_tab()` 函数，可以打开新的标签页，并在导航栏上增加了 '+' 按钮以快速新建主页。
- 绑定了 `currentChanged` 和 `tabCloseRequested` 事件，支持关闭标签、切换标签，并智能更新窗口标题、地址栏内容。
- 重构了所有的导航栏按钮（前进、后退、刷新、跳转），确保只作用于当前激活的 Tab 中的 `QWebEngineView`，而不影响后台的其他 Tab。

## [2026-02-21 22:10:00] - 批量完成任务: 书签、历史记录、搜索引擎及项目收尾
- (Task 5) 创建了 `HistoryManager` 并集成到主窗口的 `loadFinished` 事件。实现弹窗查看历史记录 (`history.json`)。
- (Task 6) 创建了 `BookmarkManager`，新增顶部菜单栏加载书签 (`bookmarks.json`)，工具栏点击 '★' 按钮快速收藏网页。
- (Task 7) 重写了地址栏的 `navigate_to_url`，实现了非标准网址字符串时，默认调用 Bing 搜索引擎查询。
- (Task 8) 添加了异常捕获（如文件读写保护），清理了相关代码，编写了详尽的 `README.md`，指导用户如何运行此浏览器。
- 所有任务执行完毕，AI 自动开发流程圆满结束！

## [2026-02-23 10:47:37] - 完成任务: Bug 修复与全面 UI 优化
- 修复了 bookmark_manager.py 和 history_manager.py 中的相对路径 Bug，现在使用绝对路径避免执行目录错误
- 修复了 bare except 语句，提高了代码健壮性
- 修复了关闭最后一个标签页时导致应用退出而非开启新页面的 Bug
- 完全重构了主界面体验：
  - 添加了现代化深色主题 (QSS)
  - 为后退、前进、主页、刷新按钮换上了图标 (StandardPixmap)
  - 增加标签页最大宽度限制以及网页 Favicon 支持
  - 地址栏下方加入了加载进度条
  - 在书签上加入了右键菜单支持：关闭、关闭其他、新建等
  - 完善了搜索引擎设置，并保存到了 settings.json（支持 Google, Bing, Baidu）
  - 历史记录对话框升级为 QTableWidget，并支持了双击跳转及一键清除历史
- 测试方法与结果：执行 python test_run.py 无报错，通过 UI 验证
- 注意事项：GUI 已接近生产环境体验

## [2026-02-23 14:00:00] - 完成任务: 下载管理器
- 创建了 `src/download_manager.py`，实现 DownloadManager 类，支持下载历史的持久化（downloads.json）
- 提供文件大小、速度、剩余时间的格式化工具方法
- 在 `main.py` 中实现了 DownloadProgressDialog（下载进度对话框）：
  - 显示实时下载速度、进度条、已下载/总大小、预计剩余时间
  - 支持取消下载、自动检测下载完成/失败/取消状态
- 实现了 DownloadHistoryDialog（下载历史记录对话框）：
  - 表格展示所有下载记录（时间、文件名、大小、状态）
  - 支持双击打开文件所在目录、打开下载文件夹、清空历史
- 在 MainWindow 集成：
  - 监听 QWebEngineProfile.downloadRequested 信号
  - 弹出保存文件对话框让用户选择保存位置
  - 菜单栏新增 "Downloads" 菜单（Show Downloads / Download History）
- 测试方法：py_compile 编译通过，模块 import 正常，格式化函数输出正确

## [2026-02-23 14:15:00] - 完成任务: 页面缩放功能
- 在 MainWindow 中实现 zoom_in / zoom_out / zoom_reset 方法
- 支持 Ctrl++ / Ctrl+= 放大、Ctrl+- 缩小、Ctrl+0 重置缩放
- 使用 `_tab_zoom_factors` 字典为每个标签页独立保存缩放比例
- 切换标签页时自动更新状态栏缩放比例显示
- 关闭标签页时清理缩放数据
- 状态栏右侧永久显示当前缩放比例（如 "100%"）
- 测试方法：py_compile 编译通过

## [2026-02-23 14:25:00] - 完成任务: 全屏浏览模式
- 实现 F11 快捷键切换全屏/正常模式
- 进入全屏时自动隐藏导航栏、标签栏、菜单栏和状态栏
- 全屏模式显示半透明退出提示 "Press F11 to exit fullscreen"，3 秒后自动消失
- 全屏下鼠标移到顶部（Y<=5px）时临时显示工具栏，移开后（Y>100px）自动隐藏
- 测试方法：py_compile 编译通过

## [2026-02-23 14:35:00] - 完成任务: 查看页面源代码
- 新增 SourceViewDialog 类，带有简单的 HTML 语法高亮（标签蓝色、属性值橙色、注释绿色）
- 使用 QTextEdit 显示源代码，设置等宽字体和暗色背景
- 支持搜索：Find Next / Find Previous 按钮 + Enter 回车快速查找
- 在菜单栏新增 "View" 菜单，包含 "Page Source" 选项
- 支持 Ctrl+U 快捷键快速查看源代码
- 使用 QWebEngineView.page().toHtml() 异步获取页面 HTML
- 测试方法：py_compile 编译通过

## [2026-02-23 14:45:00] - 完成任务: 页面内查找功能
- 新增 FindInPageBar 类，无边框浮动查找栏（类似 Chrome 的 Ctrl+F）
- 支持实时搜索：输入文字时即时查找并高亮匹配
- 提供上一个(^) / 下一个(v) / 关闭(X) 按钮
- 支持 Enter 查找下一个、Shift+Enter 查找上一个、Esc 关闭
- 支持 Ctrl+F 快捷键打开查找栏
- 显示匹配结果数量（如 "2/5"），无结果时显示红色 "No results"
- 使用 QWebEnginePage.findText() 内置查找 + 高亮功能
- 关闭时自动清除页面高亮
- 测试方法：py_compile 编译通过

## [2026-02-23 14:55:00] - 完成任务: 无痕浏览模式
- 新增 IncognitoWindow 类，继承 QMainWindow，独立于主窗口
- 使用 off-the-record QWebEngineProfile（不保存任何数据到磁盘）
- 设置 HttpCacheType.NoCache 禁用缓存
- 窗口标题前缀 "[Incognito]" 明确标识无痕模式
- 地址栏 placeholder 标注 "[Incognito]"
- 状态栏显示 "Incognito Mode: History and cookies will not be saved."
- 不调用 HistoryManager.add_history()，不保存浏览记录
- 关闭窗口时 clearHttpCache + clearAllVisitedLinks 清除所有临时数据
- 菜单 View > New Incognito Window，支持 Ctrl+Shift+N 快捷键
- 更新 WebEngineView 支持自定义 profile 参数
- 测试方法：py_compile 编译通过

## [2026-02-23] - 完成任务: 书签管理器增强
- 重写 src/bookmark_manager.py，新数据结构支持 type: "bookmark" / "folder"，文件夹可嵌套 children
- 旧格式 [{"url":..., "title":...}] 自动迁移为新格式，向后兼容
- 新增方法: add_folder, remove_folder, rename_folder, edit_bookmark, move_bookmark, get_folder_names, get_all_bookmarks_flat
- 实现 export_to_html(): Netscape Bookmark File Format，兼容 Chrome/Firefox/Edge 导入
- 实现 import_from_html(): 解析 Netscape 格式 HTML，递归处理文件夹层级，自动合并去重
- 在 src/main.py 新增 BookmarkManagerDialog 类 (~250行):
  - QTreeWidget 展示书签层级结构
  - 启用 InternalMove 拖拽排序（书签可在文件夹间拖动）
  - Add Bookmark / Add Folder / Edit / Delete 按钮
  - Import HTML / Export HTML 按钮
  - 双击书签在主窗口打开新标签页
  - 关闭对话框时自动保存拖拽排序结果
- 更新 update_bookmark_menu() 递归构建子菜单（文件夹 → QMenu 子菜单）
- 替换原 show_bookmark_manager() 占位符为完整 BookmarkManagerDialog
- 新增 PyQt6 导入: QTreeWidget, QTreeWidgetItem, QInputDialog, QAbstractItemView
- 测试方法：py_compile 两个文件均编译通过

## [2026-02-23] - 完成任务: 会话恢复功能
- 创建 src/session_manager.py，实现 SessionManager 类
  - save_session(tabs_data, active_index): 保存标签页列表和激活索引到 session.json
  - load_session(): 加载上次保存的会话
  - has_session(): 检查是否存在会话文件
  - clear_session(): 清除会话文件
- 在 MainWindow.__init__ 中：启动时检查 settings.restore_session (默认 True)，如有会话则恢复
- _restore_session(): 从 session.json 恢复所有标签页及激活标签
- _save_session(): 遍历所有标签页，保存 URL 和标题
- closeEvent(): 关闭窗口时自动调用 _save_session() 保存会话
- close_tab() 中记录关闭的标签页信息到 _closed_tabs 列表
- reopen_closed_tab(): 从 _closed_tabs 弹出最近关闭的标签页并恢复，Ctrl+Shift+T 快捷键
- 导入 SessionManager 模块
- 测试方法：py_compile 两个文件均编译通过

## [2026-02-23] - 完成任务: 快捷键系统
- 新增 ShortcutsHelpDialog 类，使用 QTableWidget 展示 18 个快捷键列表
- 在 MainWindow.__init__ 中添加所有快捷键绑定:
  - Ctrl+T: 新建标签页
  - Ctrl+W: 关闭当前标签页
  - Ctrl+Tab: 切换到下一个标签页
  - Ctrl+Shift+Tab: 切换到上一个标签页
  - Ctrl+L: 聚焦到地址栏并全选
  - Ctrl+R: 刷新页面
  - Esc: 停止页面加载 (browser.stop())
  - Ctrl+D: 快捷收藏当前页面
  - Ctrl+H: 打开历史记录
  - F1: 显示快捷键帮助
- 新增方法: switch_to_next_tab, switch_to_prev_tab, focus_url_bar, stop_page_loading, show_shortcuts_help
- 保留已有快捷键: Ctrl+F, Ctrl+U, Ctrl+Shift+N, Ctrl+Shift+T, F11, Ctrl++/-/0
- 测试方法：py_compile 编译通过

## [2026-02-23] - 完成任务: 打印与保存为PDF
- 在菜单栏新增 "File" 菜单（位于 Bookmarks 之前）
- File > Print...(Ctrl+P): 使用 QPrintPreviewDialog 显示打印预览
  - 如果 PyQt6-Qt6-Printing 不可用，提示用户使用 Save as PDF 替代
  - 通过 browser.page().print(printer, callback) 执行打印
- File > Save as PDF...: 使用 QFileDialog 选择保存路径
  - 通过 browser.page().printToPdf(filepath) 保存
  - 文件名默认使用页面标题（清理非法字符）
  - 状态栏显示保存成功提示
- 新增方法: print_page, _do_print, save_as_pdf
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 用户代理切换
- 在 Tools 菜单下添加 User-Agent 子菜单，包含 7 种预设 UA（Default, Chrome/Firefox/Safari/Edge Windows, Chrome Android, Safari iPhone）
- 预设 UA 使用单选 checkable actions，一次只能选中一个
- 支持 "Custom User-Agent..." 弹出 QInputDialog 输入自定义 UA 字符串
- 使用 QWebEngineProfile.defaultProfile().setHttpUserAgent() 应用 UA
- UA 选择持久化到 settings.json（user_agent 字段），自定义 UA 字符串存储在 user_agent_custom_string 字段
- 启动时自动恢复上次选择的 UA
- 新增方法: set_user_agent, set_custom_user_agent, _apply_user_agent
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 地址栏自动完成
- 使用 QCompleter + QStringListModel 实现地址栏自动完成
- 从历史记录（最近 500 条）和书签（递归展开文件夹）收集建议
- 建议格式: "URL  |  Title  |  History/Bookmark"，方便用户辨别来源
- 使用 MatchContains 过滤模式（输入部分文字即可匹配任意位置）
- 选择建议后自动提取 URL 并导航
- 引入 2 秒缓存失效机制，避免每次按键都读文件
- 新增 import: QCompleter, QStyledItemDelegate, QStringListModel
- 新增方法: _collect_suggestions, _collect_bookmark_suggestions, _refresh_completer_model, _invalidate_completer_cache, _on_completer_activated
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 标签页固定功能
- 在标签页右键菜单添加 "Pin Tab" / "Unpin Tab" 选项
- 固定标签页显示 📌 图标 + 缩短标题（最多 8 字符）
- 固定标签页自动移到标签栏最左侧（固定区域）
- 固定标签页无法通过常规方式关闭（close_tab 检查）
- 右键菜单中固定标签页的 Close 选项灰显
- 标题更新时自动适配固定/非固定显示格式
- 固定状态在 session.json 中持久化（pinned 字段）
- 会话恢复时自动还原固定状态
- 使用 self._pinned_tabs (set of widget id) 跟踪状态
- 新增方法: pin_tab, unpin_tab, _pinned_tab_count, _update_pinned_tab_appearance
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 浏览器设置中心
- 新增 SettingsDialog 类，完整的设置对话框，左侧分类列表 + 右侧分页布局
- 四个分类页面：
  - General: 主页设置、搜索引擎、启动行为（恢复会话）、下载位置
  - Privacy: 弹窗拦截、Do Not Track、JavaScript 开关、清除缓存/Cookie/历史按钮
  - Appearance: 主题选择（Dark/Light，预留扩展）、默认缩放比例
  - Advanced: User-Agent 选择、硬件加速、HTTP 代理设置
- "Restore Defaults" 按钮一键恢复所有默认值
- OK 保存设置并实时应用，Cancel 放弃修改
- 应用设置时实时更新：搜索引擎下拉框、UA、JavaScript 开关
- 入口：Tools > Settings...（Ctrl+,）
- 新增 import: QCheckBox, QGroupBox, QFormLayout, QListWidget, QStackedWidget, QListWidgetItem, QFrame, QWidget
- 新增方法: open_settings_dialog, _apply_settings_changes
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: Cookie 和缓存管理
- 增强 SettingsDialog 隐私页面：
  - 添加时间范围选择器（Last hour / Today / Today and yesterday / Last 7 days / All time）
  - 可选清除类型：Cache / Cookies / History / Download records
  - "Clear Data" 按钮一键清除选中数据
  - "Manage Cookies..." 按钮打开独立的 Cookie 管理对话框
- 新增 CookieManagerDialog 类：
  - 显示所有网站的 Cookies（域名、名称、值、过期时间）
  - 搜索栏按域名实时过滤
  - 支持删除选中 Cookie、按域名删除、删除所有 Cookies
  - 通过 QWebEngineProfile cookieStore().cookieAdded 信号收集 cookies
- 在 Tools 菜单添加 "Cookie Manager..." 入口
- 历史记录支持按时间范围清除（保留截止时间之前的记录）
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 开发者工具集成
- 在 Tools 菜单添加 "Developer Tools" (F12) 和 "Inspect Element" (Ctrl+Shift+I)
- 使用 page().setDevToolsPage() 将当前页面的 DevTools 绑定到独立窗口
- DevTools 在独立的 QMainWindow 中打开（900x600）
- 支持 toggle：再次按 F12 关闭 DevTools 窗口
- DevTools 窗口引用存储在 self._devtools_window
- 新增方法: toggle_devtools
- 测试方法：py_compile 编译通过

## [2026-02-24] - 完成任务: 网页截图功能
- 在 Tools 菜单添加 "Screenshot (Visible Area)" (Ctrl+Shift+S) 和 "Screenshot (Full Page)"
- 可见区域截图使用 browser.grab()
- 全页截图通过 JavaScript 获取页面完整尺寸，临时调整视图大小后截图，再恢复原尺寸
- 截图预览对话框：带滚动区域显示缩放后的截图预览
- 支持保存为 PNG 和 JPG 格式（JPG 质量 90）
- 文件名默认使用页面标题（清理非法字符）
- 新增方法: screenshot_visible, screenshot_full_page, _on_full_page_size, _capture_and_restore, _show_screenshot_preview, _save_screenshot
- 测试方法：py_compile 编译通过
